# @package _global_

# to execute this experiment run:
# python train.py experiment=example

defaults:
  - override /data: all
  - override /model: all
  - override /callbacks: default
  - override /trainer: gpu
  - override /logger: wandb

# all parameters below will be merged with parameters from default configurations set above
# this allows you to overwrite only specified parameters

tags: "race"

seed: 12345

data:
  _target_: src.data.face_datamodule_leonard.FaceDataModule_Leo
  num_workers: 4
  img_dir: /media/gnort/HDD6/Study/face-analysis-lightning/dataset/face_challenge_dataset # old dataset + new race dataset
  image_train_list: ${data.img_dir}/image_lists_full/image_lists_full/train.txt # new train list
  image_test_list: ${data.img_dir}/image_lists_full/image_lists_full/test.txt # default test dataset
  mean: [0.485, 0.456, 0.406]
  std: [0.229, 0.224, 0.225]
  image_size: 256
  crop_size: 224
  batch_size: 32 # Needs to be divisible by the number of devices (e.g., if in a distributed setup)
  val_test_split: [0.5, 0.5]
  pin_memory: False
  transform: True
  age_to_ordinal: True
  # backbone_name: ${model.backbone.name}

trainer:
  # limit_train_batches: 0.05
  # limit_val_batches: 0.1
  # limit_test_batches: 0.1
  # accelerator: cpu
  # devices: 1
  # detect_anomaly: true
  accelerator: gpu
  min_epochs: 20
  max_epochs: 100
  gradient_clip_val: 0.5

model:
  _target_: src.models.face_module.FaceLitModule
  # checkpoint_dir: /media/gnort/HDD6/Study/face-analysis-lightning/tests/
  optimizer:
    _target_: torch.optim.Adam
    lr: 0.001
    # momentum: 0.9
    # weight_decay: 1e-6
  # criterion:
    # _target_: src.losses.focal_loss.FocalLoss
    # _target_: src.losses.loss.CrossEntropyLoss
    # gamma: 2.0
    # alpha: [0.15, 0.15, 0.7]
  scheduler:
    _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
    _partial_: true
    mode: min
    factor: 0.1
    patience: 10
  net:
    _target_: src.models.components.face_attrs_classifier.FaceAttrsClassifier  
    backbone: resnet50
    race_output_size: 4
    gender_output_size: 2
    age_output_size: 6
    skintone_output_size: 4
    emotion_output_size: 7
    masked_output_size: 1
  pretrained: "/media/gnort/HDD6/Study/face-analysis-lightning/weights/best_resnet_101_student_e56_cpu.pth"
  compile: True
  num_classes: [4, 2, 6, 4, 7, 1] #race, gender, age, skintone, emotions, masked
  num_heads: 6
  attributes: ["race", "gender", "age", "skintone", "emotion", "masked"]

callbacks:
  early_stopping:
    mode: "max"
  
logger:
  wandb:
    tags: ${tags}
    group: "f_all"
  aim:
    experiment: "f_all"




